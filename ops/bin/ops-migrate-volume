#!/bin/bash
set -euo pipefail
source "$(dirname "$0")/common.sh"

if [ $# -lt 3 ]; then
    log_err "Usage: ops-migrate-volume <old_volume> <new_volume> <app_directory>"
    exit 1
fi

OLD_VOL="$1"
NEW_VOL="$2"
APP_DIR="$3"

log_warn "Migrating data from $OLD_VOL to $NEW_VOL"

# 1. Create new volume if not exists
if ! docker volume inspect "$NEW_VOL" >/dev/null 2>&1; then
    log_info "Creating new volume: $NEW_VOL"
    docker volume create "$NEW_VOL"
fi

# 2. Copy data using a helper container
log_info "Copying data... this might take a moment."
docker run --rm \
    -v "$OLD_VOL:/from" \
    -v "$NEW_VOL:/to" \
    alpine sh -c "cp -av /from/. /to/"

log_info "Migration of volume $OLD_VOL to $NEW_VOL complete."
