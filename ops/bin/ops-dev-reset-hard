#!/bin/bash
set -euo pipefail
source "$(dirname "$0")/common.sh"

if [ $# -lt 1 ]; then
    log_err "Usage: ops-dev-reset-hard <app_name>"
    exit 1
fi

APP_NAME="$1"
PROJECT_NAME="dev_$APP_NAME"

log_warn "!!! HARD RESET REQUESTED FOR DEV PROJECT: $PROJECT_NAME !!!"
log_warn "This will DELETE ALL DATA in labels/volumes prefixed with $PROJECT_NAME."

# SAFETY CHECK
if [[ "$PROJECT_NAME" == *"prod"* ]]; then
    log_err "CRITICAL ERROR: Refusing to hard reset a PRODUCTION project."
    exit 1
fi

read -p "Are you sure? This is DESTRUCTIVE for $PROJECT_NAME. (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    log_info "Abort."
    exit 0
fi

# Find compose file
COMPOSE_FILE=$(find "$APPS_ROOT/$APP_NAME" -name "docker-compose.dev.yml" | head -n 1)

if [ -n "$COMPOSE_FILE" ]; then
    log_info "Running: docker compose -p $PROJECT_NAME -f $COMPOSE_FILE down -v --rmi local"
    docker compose -p "$PROJECT_NAME" -f "$COMPOSE_FILE" down -v --rmi local
else
    log_warn "No docker-compose.dev.yml found. Manual cleanup of volumes starting with dev_$APP_NAME..."
    # Cleanup volumes
    VOLUMES=$(docker volume ls --format "{{.Name}}" | grep "^dev_$APP_NAME" || true)
    if [ -n "$VOLUMES" ]; then
        docker volume rm $VOLUMES
    fi
fi

log_info "Hard reset of $PROJECT_NAME complete."
echo "$(date): ops-dev-reset-hard $APP_NAME" >> "$LOG_DIR/ops.log"
